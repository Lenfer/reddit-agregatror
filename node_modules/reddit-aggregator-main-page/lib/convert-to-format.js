'use strict'

const _ = require('lodash');

let converter = {};

/**
 * Экранируем строку (для формата CSV)
 * @param {Any} value Строка
 * @private
 * @returns {String} Экранированная строка
 */
function escapingCsvСhar(value) {
	return '"' + value.toString().replace(/"/g, '""') + '"';
}


converter.csv = function(data, options) {
	let csvDelemiter = options.csvDelemiter || ';';
	let fieldMap = options.fieldMap || {};
	return _.map(data, (item) => {
		let values = [];
		_.each(fieldMap, (path, fieldName) => {
			values.push(escapingCsvСhar(_.get(item, path)));
		});
		return values.join(csvDelemiter);
	}, []).join('\r\n')
};



converter.sql = function(data, options) {
	let tableName = options.tableName || 'table';
	let fieldMap = options.fieldMap || {};
	return _.map(data, (item) => {
		let fields = [];
		let values = [];
		_.each(fieldMap, (path, fieldName) => {
			fields.push(fieldName);
			values.push( ['"', _.get(item, path), "'"].join(''));
		});
		return `INSERT INTO ${tableName} (${fields.join(', ')}) VALUES (${values.join(', ')});`
	}, []).join('\n')
};

module.exports = function(format, data, options) {
	let conv = converter[format];

	if (conv) {
		return conv(data, options);
	} else {
		let message = `Unknown format ${format}`;
		options.log.error(options.req, message);
		return message;
	}

};