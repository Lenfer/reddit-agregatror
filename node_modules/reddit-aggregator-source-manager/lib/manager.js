'use strict';

const Vow = require('vow');
const request = require('request');


const REDDITURL = 'https://www.reddit.com/';
const url = require('url');

const log = require('reddit-aggregator-logger')('source-manager');


const sourceManager = {

	/**
	 * Получить данные с сайта Reddit
	 * @param {Object} options Объект с параметрами запроса
	 * @param {String} options.req Объект пользовательского запроса
	 * @param {String} [options.category=''] Категория
	 * @returns {Promise}
	 */
	get: (options) => {
		const promise = Vow.promise();
		const category = options.category || '';
		let dataUrl = url.resolve(REDDITURL, ['r', category, '.json'].join('/'));
		let req = options.req;

		log.info(req, `Try get data from reddit by adress ${dataUrl}`);

		request(dataUrl, function (error, response, body) {
			if (!error && response.statusCode == 200) {
				log.info(req, 'Data from reddit.com succefull getted', {
					length: body.length
				});
				promise.fulfill(body);
			} else {
				log.error(req, `Error on get data from reddit.com`, error || response);
				promise.reject(error || response.statusCode);
			}
		})
		return promise;
	}
}

module.exports = sourceManager;

